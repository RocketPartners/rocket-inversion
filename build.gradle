buildscript {
    ext {
        springBootVersion = '1.5.6.RELEASE'
    }
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
    }
}

plugins {
    id 'maven-publish'
}

apply plugin: 'eclipse'
apply plugin: 'maven'
apply plugin: 'java'
apply plugin: 'org.springframework.boot'

//README uncomment the line below to use 'gradle build' to package a war.
//This file is shipped as a java plugin project not a war plugin project because
//other projects use jitpack to include the snooze api as a dependency.  If
//it were a war project by default jipack would serve the war not the jar which
//would be useless.
//apply plugin: 'war'

project.docsDirName = '../docs/0.3.x/'

configurations.all { resolutionStrategy.cacheChangingModulesFor 0, 'seconds' }


version = '0.4.1'
group = 'com.github.RocketPartners'
sourceCompatibility = 1.8

repositories {
    mavenLocal()
    maven {
        name = 'github'
        url = 'https://maven.pkg.github.com/RocketPartners/artifacts'
        credentials {
            username = System.env.GHP_USER
            password = System.env.GHP_PASSWORD
        }
    }
    maven { url "http://redshift-maven-repository.s3-website-us-east-1.amazonaws.com/release" }
    mavenCentral()
}

publishing {
    repositories {
        maven {
            name = 'github'
            url = 'https://maven.pkg.github.com/RocketPartners/artifacts'
            credentials {
                username = System.env.GHP_USER
                password = System.env.GHP_PASSWORD
            }
        }
    }
}

dependencies {

    compile 'org.springframework.boot:spring-boot-starter-web'
    compile 'org.springframework.boot:spring-boot-starter-actuator'
    compile 'org.springframework.boot:spring-boot-starter-jdbc'
    compile 'org.springframework.boot:spring-boot-starter-test'
    compile 'net.rakugakibox.spring.boot:logback-access-spring-boot-starter:2.6.0'

    implementation 'com.sun.xml.bind:jaxb-impl:4.0.0'
    implementation 'jakarta.xml.bind:jakarta.xml.bind-api:2.3.3'

    compile group: 'org.apache.commons', name: 'commons-collections4', version: '4.3'
    compile group: 'org.apache.commons', name: 'commons-lang3', version: '3.8.1'
    compile group: 'org.apache.commons', name: 'commons-csv', version: '1.4'

    compile group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.5'
    compile group: 'org.apache.httpcomponents', name: 'httpmime', version: '4.5.5'

    //aws libs
    //compile 'com.amazonaws:aws-java-sdk:1.11.547'
    compile 'com.amazonaws:aws-java-sdk-s3:1.11.390'
    compile 'com.amazonaws:aws-java-sdk-dynamodb:1.11.390'
    compile 'com.amazonaws:aws-java-sdk-kinesis:1.11.390'
    compile 'com.amazonaws:aws-lambda-java-core:1.2.0'
    compile 'com.amazonaws:aws-java-sdk-rds:1.11.542'

    // required for the Redis client
    compile group: 'redis.clients', name: 'jedis', version: '2.9.0'

    //drivers for supportd DBs
    compile group: 'com.zaxxer', name: 'HikariCP', version: '3.3.1' //required connection pool libs
    compile group: 'mysql', name: 'mysql-connector-java', version: '5.1.34'
    compile group: 'com.h2database', name: 'h2', version: '1.4.197'
    compile 'org.postgresql:postgresql:42.1.4'
//	 https://mvnrepository.com/artifact/com.amazon.redshift/redshift-jdbc42-no-awssdk
    compileOnly group: 'com.amazon.redshift', name: 'redshift-jdbc42-no-awssdk', version: '1.2.10.1009'

    // Beware of changing the redshift driver version. Newer versions of this driver are not thread-safe
    // Version 1.2.10.1009 is thread-safe
    // https://stackoverflow.com/questions/52884036/java-sql-sqlnontransientexception-amazonjdbc10900-not-all-parameters-have

    //scripting with javascript via graalvm (from oracle and newer than rhino/nashorn)
    compile 'net.jodah:expiringmap:0.5.8'
    compile group: 'org.graalvm', name: 'graal-sdk', version: '1.0.0-rc7'
    compile group: 'com.oracle.truffle', name: 'truffle-api', version: '1.0.0-rc7'
    compile files('libs/graaljs.jar') //does not appear to be in maven yet
    compile files('libs/tregex.jar')  //does not appear to be in maven yet

    //scripting with velocity engine
    compile group: 'org.apache.velocity', name: 'velocity-engine-core', version: '2.0'

    testCompile 'junit:junit:4.12'
}


/************************************************************
 * Ensuring source directories are created if they do not 
 * already exist when running 'gradle eclipse'
 */
eclipse {
    classpath {
        file {
            tasks.eclipse.dependsOn(cleanEclipseClasspath)
            tasks.eclipse.dependsOn("create-dirs")
        }
    }
}


/************************************************************
 * This task should be used when creating a new project as
 * it will create all source and resource directories.  This
 * task is automatically executed during the 
 * 'gradle eclipse' command.
 */
task "create-dirs" {
    doLast {
        sourceSets*.java.srcDirs*.each { it.mkdirs() }
        sourceSets*.resources.srcDirs*.each { it.mkdirs() }
    }
}

javadoc {
//   exclude "**/utils/**"
}

test {
    exclude '**/*'
}

uploadArchives {
    repositories {
        mavenDeployer {
            repository(url: 'https://maven.pkg.github.com/RocketPartners/artifacts') {
                authentication(userName: System.env.GHP_USER, password: System.env.GHP_PASSWORD)
            }
        }
    }

    doFirst {
        println "API user: ${System.env.GHP_USER}"
        println "${jar.archiveName} -> 'https://maven.pkg.github.com/RocketPartners/artifacts'"
    }
    dependsOn assemble
}
